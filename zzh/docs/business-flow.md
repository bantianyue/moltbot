# Moltbot 业务流程图

## 一、消息处理主流程

### 1.1 整体流程图

```
┌─────────┐
│  开始   │
└────┬────┘
     │
     ▼
┌─────────────────┐
│ 用户在消息平台   │
│   发送消息      │
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│  通道接收消息    │
│ (WhatsApp/TLG  │
│  Slack/Discord)│
└────┬────────────┘
     │
     ▼
┌─────────────────┐
│ Gateway 路由    │
│   消息         │
└────┬────────────┘
     │
     ▼
┌──────────────────┐     是     ┌──────────────┐
│ 用户是否已配对？  │──────────▶│ 返回配对请求  │
└────┬─────────────┘          └──────┬───────┘
     │ 否                            │
     │                               │ 确认后
     ▼                               ▼
┌─────────────────┐            ┌──────────────┐
│ 查找或创建会话  │◀───────────│   用户配对    │
└────┬────────────┘            └──────┬───────┘
     │                               │
     ▼                               │
┌─────────────────┐                  │
│ 转发到 Pi Agent │                  │
└────┬────────────┘                  │
     │                               │
     ▼                               │
┌─────────────────┐                  │
│ AI 处理消息     │                  │
│ (携带上下文)    │                  │
└────┬────────────┘                  │
     │                               │
     ▼                               │
┌──────────────────┐     是          │
│  是否需要工具？  │────────┐        │
└────┬─────────────┘        │        │
     │ 否                   │        │
     ▼                      │        │
┌─────────────────┐         │        │
│ 生成响应并返回  │         │        │
└────┬────────────┘         │        │
     │                     │        │
     │                     ▼        │
     │            ┌──────────────────┐│
     │            │   执行工具        ││
     │            │ - 浏览器操作      ││
     │            │ - 画布渲染        ││
     │            │ - 节点调用        ││
     │            └──────┬───────────┘│
     │                   │            │
     │                   ▼            │
     │            ┌──────────────────┐│
     │            │  返回工具结果     ││
     │            └──────┬───────────┘│
     │                   │            │
     └───────────────────┘            │
           │                         │
           ▼                         │
┌─────────────────┐                  │
│ AI 继续处理     │                  │
│ (带工具结果)    │                  │
└────┬────────────┘                  │
     │                               │
     ▼                               │
┌─────────────────┐                  │
│ 流式返回响应     │                  │
└────┬────────────┘                  │
     │                               │
     ▼                               │
┌─────────────────┐                  │
│ 广播到所有客户端 │                  │
│ (WebUI/App等)   │                  │
└────┬────────────┘                  │
     │                               │
     ▼                               │
┌─────────────────┐                  │
│ 通道发送回复     │                  │
│ 给用户          │                  │
└────┬────────────┘                  │
     │                               │
     ▼                               │
┌─────────────────┐                  │
│     结束        │◀─────────────────┘
└─────────────────┘
```

### 1.2 详细步骤说明

```
步骤 1: 消息接收
┌─────────────────────────────────────────────┐
│ • 用户在 WhatsApp/Telegram/Slack 等平台   │
│   发送消息                                │
│ • 通道 SDK 接收消息事件                    │
│ • 提取消息内容、发送者信息、群组信息      │
└─────────────────────────────────────────────┘
                  │
                  ▼
步骤 2: 用户配对检查
┌─────────────────────────────────────────────┐
│ • Gateway 检查发送者是否在允许列表中      │
│ • 未知用户触发配对流程                    │
│ • 等待用户确认（通过 WebUI 或 CLI）      │
│ • 配对成功后创建用户配置                  │
└─────────────────────────────────────────────┘
                  │
                  ▼
步骤 3: 会话管理
┌─────────────────────────────────────────────┐
│ • 查找现有会话或创建新会话                │
│ • 加载会话历史（上下文）                  │
│ • 从向量记忆检索相关信息                  │
│ • 准备发送给 Agent 的完整上下文           │
└─────────────────────────────────────────────┘
                  │
                  ▼
步骤 4: AI 处理
┌─────────────────────────────────────────────┐
│ • 发送到 Pi Agent 运行时                  │
│ • LLM 处理消息（带完整上下文）            │
│ • 判断是否需要调用工具                    │
│ • 决策：直接回答 vs 工具调用              │
└─────────────────────────────────────────────┘
                  │
                  ▼
步骤 5: 工具执行（如需要）
┌─────────────────────────────────────────────┐
│ • Agent 调用工具                          │
│ • Gateway 验证权限                        │
│ • 执行工具（浏览器/画布/节点等）          │
│ • 流式返回结果给 Agent                    │
│ • Agent 可能继续调用更多工具               │
└─────────────────────────────────────────────┘
                  │
                  ▼
步骤 6: 响应返回
┌─────────────────────────────────────────────┐
│ • Agent 生成最终响应                      │
│ • 流式返回到 Gateway                      │
│ • Gateway 广播到所有连接的客户端          │
│   (WebUI、移动应用、CLI)                 │
│ • 原通道发送回复给用户                    │
└─────────────────────────────────────────────┘
```

## 二、工具执行流程

### 2.1 工具执行决策树

```
                    Agent 决策
                         │
                         ▼
              ┌──────────────────┐
              │   需要调用工具？   │
              └────┬─────────┬───┘
                   │ 是      │ 否
                   ▼         │
          ┌──────────────┐    │
          │ 选择工具类型  │    │
          └──────┬───────┘    │
                 │            │
        ┌────────┼────────┐   │
        │        │        │   │
    ┌───▼──┐ ┌──▼───┐ ┌─▼───▼───┐
    │浏览器│ │画布  │ │节点工具 │
    │工具  │ │工具  │ │         │
    └───┬──┘ └──┬───┘ └───┬─────┘
        │       │         │
        ▼       ▼         ▼
┌───────────┐ ┌─────┐ ┌────────┐
│启动/连接  │ │创建 │ │查找设备 │
│浏览器实例  │ │画布 │ │        │
└─────┬─────┘ └──┬──┘ └───┬────┘
      │          │        │
      ▼          ▼        ▼
┌───────────┐ ┌─────┐ ┌────────┐
│执行操作:  │ │渲染 │ │转发工具 │
│- 导航    │ │HTML │ │调用到   │
│- 点击    │ │CSS  │ │设备节点 │
│- 输入    │ │     │ │        │
│- 截图    │ │     │ │        │
└─────┬─────┘ └──┬──┘ └───┬────┘
      │          │        │
      ▼          ▼        ▼
┌───────────┐ ┌─────┐ ┌────────┐
│返回操作   │ │更新 │ │返回节点 │
│结果       │ │画布 │ │响应     │
└───────────┘ └──┬──┘ └───┬────┘
                  │        │
                  └───┬────┘
                      ▼
              ┌──────────────┐
              │ 结果返回Agent │
              │ 继续处理     │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐
              │ 生成最终响应 │
              └──────────────┘
```

### 2.2 工具执行详细流程

```
┌────────────────┐
│ Agent 请求工具 │
└───────┬────────┘
        │
        ▼
┌────────────────────────────────────────┐
│  Gateway 权限验证                     │
│  ├─ 检查工具是否被允许                │
│  ├─ 验证用户权限                     │
│  └─ 检查参数有效性                   │
└───────┬────────────────────────────────┘
        │ 权限验证失败
        ▼
┌────────────────┐
│ 返回权限错误  │
└───────────────┘

        │ 权限验证通过
        ▼
┌────────────────────────────────────────┐
│  工具类型判断                         │
└───────┬────────────────────────────────┘
        │
        ├─────────────┬─────────────┬──────────────┐
        │             │             │              │
        ▼             ▼             ▼              ▼
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│ 浏览器   │  │ 画布     │  │ 节点     │  │ 会话     │
│ 工具     │  │ 工具     │  │ 工具     │  │ 工具     │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │
     ▼             ▼             ▼             ▼
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│启动Chrome│  │初始化A2UI│  │查找设备  │  │查询会话  │
│DevTools │  │协议      │  │(mac/iOS/ │  │数据库    │
│会话     │  │          │  │ Android) │  │          │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │
     ▼             ▼             ▼             ▼
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│执行操作: │  │创建/更新│  │转发工具  │  │执行操作: │
│- 导航URL│  │HTML界面  │  │调用      │  │- 创建   │
│- 填写表单│  │实时渲染 │  │          │  │- 查询   │
│- 点击按钮│  │          │  │          │  │- 删除   │
│- 截图   │  │          │  │          │  │          │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │
     ▼             ▼             ▼             ▼
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│返回页面  │  │返回画布  │  │返回设备  │  │返回会话  │
│内容/截图 │  │状态      │  │响应      │  │操作结果  │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │
     └─────────────┴─────────────┴─────────────┘
                       │
                       ▼
              ┌────────────────┐
              │  处理并返回   │
              │  工具执行结果 │
              └───────┬───────┘
                      │
                      ▼
              ┌────────────────┐
              │  流式返回Agent │
              │  继续对话     │
              └────────────────┘
```

## 三、客户端连接与认证流程

### 3.1 连接认证流程

```
┌─────────┐
│ 客户端   │
│ 启动     │
└────┬────┘
     │
     ▼
┌─────────────────────┐
│ 连接 WebSocket     │
│ (ws://localhost:  │
│  18789)           │
└──────┬────────────┘
       │
       ▼
┌─────────────────────┐
│ 发送 connect 帧    │
│ - 设备信息         │
│ - 客户端类型       │
│ - 认证凭证         │
└──────┬────────────┘
       │
       ▼
┌─────────────────────┐
│ Gateway 验证       │
└────┬──────────────┘
     │
     ▼
┌──────────────────────────────────┐
│         认证方式判断            │
└────┬─────────────┬──────────────┘
     │             │
     │ Token       │ 设备认证
     ▼             ▼
┌──────────┐  ┌──────────┐
│验证Token │  │验证设备ID │
└────┬─────┘  └────┬─────┘
     │             │
     │             ▼
     │        已配对设备？
     │        ┌────┴─────┐
     │        │ 是       │ 否
     │        ▼          ▼
     │   ┌────────┐ ┌──────────┐
     │   │验证通过 │ │返回 401  │
     │   │        │ │需要配对  │
     │   └───┬────┘ └────┬─────┘
     │       │            │
     │       │            ▼
     │       │     ┌────────────┐
     │       │     │ 用户发起    │
     │       │     │ 配对请求    │
     │       │     └─────┬──────┘
     │       │           │
     │       │           ▼
     │       │     ┌────────────┐
     │       │     │ 生成配对码  │
     │       │     └─────┬──────┘
     │       │           │
     │       │           ▼
     │       │     ┌────────────┐
     │       │     │ 用户确认    │
     │       │     │ 配对码      │
     │       │     └─────┬──────┘
     │       │           │
     │       │           ▼
     │       │     ┌────────────┐
     │       │     │ 配对成功    │
     │       │     └─────┬──────┘
     │       │           │
     └───────┴───────────┘
             │
             ▼
     ┌──────────────┐
     │ 认证成功     │
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐
     │ 加载完整状态 │
     │ (hello-ok)   │
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐
     │ 订阅事件流   │
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐
     │ 开始通信     │
     │ (ping/pong)  │
     └──────────────┘
```

### 3.2 连接保持机制

```
┌──────────────┐
│  连接已建立  │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────────┐
│  循环：心跳保活               │
│  ├─ 客户端定时发送 ping       │
│  ├─ 服务端响应 pong           │
│  └─ 超时未响应则断开重连     │
└────────┬───────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│  循环：事件监听               │
│  ├─ 接收服务端推送事件        │
│  ├─ 处理消息/响应/通知        │
│  └─ 更新 UI 状态              │
└────────┬───────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│  循环：命令发送               │
│  ├─ 用户操作触发命令          │
│  ├─ 发送到服务端              │
│  └─ 等待响应                 │
└────────┬───────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│  异常处理                     │
│  ├─ 网络断开 → 自动重连       │
│  ├─ 认证失败 → 重新认证       │
│  └─ 服务端错误 → 显示错误      │
└─────────────────────────────────┘
```

## 四、会话管理流程

### 4.1 会话生命周期状态图

```
                           [新用户]
                               │
                               ▼
┌──────────────────────────────────────────┐
│            未配对状态                   │
│  • 接收消息但拒绝处理                  │
│  • 返回配对请求                        │
│  • 等待用户确认                       │
└────┬───────────────────────────────────┘
     │ 用户确认配对
     ▼
┌──────────────────────────────────────────┐
│            已配对状态                   │
│  • 用户在允许列表中                    │
│  • 可以接收和处理消息                  │
└────┬───────────────────────────────────┘
     │ 首次对话
     ▼
┌──────────────────────────────────────────┐
│           会话创建中                   │
│  • 初始化会话对象                      │
│  • 加载用户配置                        │
│  • 准备初始上下文                      │
└────┬───────────────────────────────────┘
     │ 初始化完成
     ▼
┌──────────────────────────────────────────┐
│           活跃会话                     │
│  • 维护对话历史                        │
│  • 处理用户消息                        │
│  • 执行 AI 推理                        │
│  • 调用工具                            │
└────┬───────────────────────────────────┘
     │
     ├─────────────┬─────────────┐
     │             │             │
     ▼             ▼             ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│用户继续  │  │用户停止  │  │长时间未  │
│发送消息  │  │或超时    │  │活动      │
└────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │
     │             ▼             ▼
     │        ┌──────────┐  ┌──────────┐
     │        │  暂停    │  │  暂停   │
     │        │状态     │  │  状态   │
     │        │(保留状态)│  │(保留状态)│
     │        └────┬─────┘  └────┬─────┘
     │             │             │
     │             │ 用户恢复    │ 超过保留期
     │             │             │
     │             ▼             ▼
     │        ┌──────────┐  ┌──────────┐
     │        │ 恢复活跃 │  │  已归档 │
     │        └────┬─────┘  └────┬─────┘
     │             │             │
     │             └─────────────┘
     │                           │
     │ 手动归档                   │
     ▼                           │
┌──────────┐                     │
│  已归档  │◀────────────────────┘
│ (持久化  │
│  存储)   │
└────┬─────┘
     │
     ▼
┌──────────┐
│   结束   │
└──────────┘
```

### 4.2 会话上下文管理

```
┌────────────────────────────────────────────┐
│          会话上下文组成                  │
├────────────────────────────────────────────┤
│                                            │
│  ┌────────────────────────────────────┐   │
│  │      消息历史                     │   │
│  │  ├─ 用户消息                      │   │
│  │  ├─ AI 响应                       │   │
│  │  └─ 时间戳                        │   │
│  └────────────────────────────────────┘   │
│                   │                       │
│  ┌────────────────────────────────────┐   │
│  │      工具调用记录                 │   │
│  │  ├─ 工具名称                      │   │
│  │  ├─ 调用参数                      │   │
│  │  └─ 执行结果                      │   │
│  └────────────────────────────────────┘   │
│                   │                       │
│  ┌────────────────────────────────────┐   │
│  │      向量记忆                     │   │
│  │  ├─ 相关历史片段                  │   │
│  │  ├─ 知识检索结果                  │   │
│  │  └─ 重要性权重                    │   │
│  └────────────────────────────────────┘   │
│                   │                       │
│  ┌────────────────────────────────────┐   │
│  │      用户配置                     │   │
│  │  ├─ 语言偏好                      │   │
│  │  ├─ 权限设置                      │   │
│  │  └─ 个性化参数                    │   │
│  └────────────────────────────────────┘   │
│                                            │
└────────────────────────────────────────────┘
                  │
                  ▼
┌────────────────────────────────────────────┐
│          上下文管理策略                  │
├────────────────────────────────────────────┤
│  • 消息限制: 保留最近 N 条消息            │
│  • Token 计算: 避免超出模型限制          │
│  • 压缩策略: 低优先级消息合并            │
│  • 记忆检索: 基于语义相似度              │
│  • 定期清理: 删除过期归档会话            │
└────────────────────────────────────────────┘
```

## 五、插件加载与扩展流程

### 5.1 插件加载流程

```
┌─────────┐
│ Gateway │
│ 启动    │
└────┬────┘
     │
     ▼
┌──────────────────────┐
│ 扫描 extensions/    │
│ 目录                │
└──────┬───────────────┘
       │
       ▼
┌─────────────────────────────────┐
│ 发现每个子目录                 │
│ ├─ 检查是否为有效插件目录      │
│ └─ 查找 clawdbot.plugin.json  │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│ 读取并验证插件清单             │
│ ├─ 解析 JSON 格式              │
│ ├─ 验证必需字段                │
│ └─ 检查版本兼容性             │
└──────┬──────────────────────────┘
       │ 验证失败
       ▼
┌──────────┐
│ 记录错误 │
│ 跳过插件 │
└──────────┘

       │ 验证成功
       ▼
┌─────────────────────────────────┐
│ 依赖关系检查                   │
│ ├─ 解析插件依赖                │
│ ├─ 检查依赖是否已安装          │
│ └─ 确定加载顺序                │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│ 依赖处理                       │
│ ├─ 所有依赖满足？              │ 是 │
│ │                              ▼   │
│ │ 否                    ┌──────────┐
│ │                       │ 加载插件 │
│ ▼                       └────┬─────┘
│ ┌────────────────┐            │
│ │ 解析并安装依赖  │            │
│ │ (pnpm install)  │            │
│ └───────┬────────┘            │
│         │                      │
│         └──────────────────────┘
│                  │
                  ▼
         ┌──────────────────┐
         │  注册插件功能     │
         │  ├─ 通道注册      │
         │  ├─ 工具注册      │
         │  └─ 钩子注册      │
         └──────┬───────────┘
                │
                ▼
         ┌──────────────────┐
         │  检查自动启用    │
         └──────┬───────────┘
                │
       ┌────────┴────────┐
       │ 是             │ 否
       ▼               ▼
┌────────────┐  ┌────────────┐
│ 启用插件   │  │ 等待用户  │
│ 调用onLoad │  │ 配置      │
└─────┬──────┘  └─────┬──────┘
      │               │
      │               │ 用户配置通道
      │               ▼
      │         ┌────────────┐
      │         │ 启用插件   │
      │         └─────┬──────┘
      │               │
      └───────┬───────┘
              │
              ▼
     ┌────────────────┐
     │  插件就绪      │
     │  可以使用      │
     └────────────────┘
```

### 5.2 插件钩子系统

```
┌────────────────────────────────────────────┐
│            插件生命周期钩子              │
├────────────────────────────────────────────┤
│                                            │
│  onLoad     ───────────► 插件加载时       │
│   ├─ 初始化插件                           │
│   ├─ 注册功能                              │
│   └─ 建立连接                              │
│                                            │
│  onConfig  ───────────► 配置变更时         │
│   ├─ 重新加载配置                          │
│   ├─ 更新插件状态                          │
│   └─ 通知其他组件                          │
│                                            │
│  onUnload  ───────────► 插件卸载时         │
│   ├─ 清理资源                              │
│   ├─ 关闭连接                              │
│   └─ 注销功能                              │
│                                            │
│  beforeMessage ───────► 消息发送前         │
│   ├─ 拦截消息                              │
│   ├─ 修改内容                              │
│   └─ 阻止发送                              │
│                                            │
│  afterMessage ────────► 消息接收后         │
│   ├─ 处理响应                              │
│   ├─ 触发动作                              │
│   └─ 记录日志                              │
└────────────────────────────────────────────┘
```

## 六、技能(Skills)系统流程

### 6.1 技能发现与安装

```
┌──────────────────────────────────────────────┐
│           技能发现流程                      │
├──────────────────────────────────────────────┤
│                                              │
│  ┌────────────────────────────────────┐      │
│  │  扫描技能源                       │      │
│  ├────────────────────────────────────┤      │
│  │  1. bundled skills (核心包)       │      │
│  │  2. managed registry (托管)       │      │
│  │  3. workspace skills (自定义)      │      │
│  └────────────────────────────────────┘      │
│                  │                           │
│                  ▼                           │
│  ┌────────────────────────────────────┐      │
│  │  读取 SKILL.md                    │      │
│  ├────────────────────────────────────┤      │
│  │  • 技能描述                       │      │
│  │  • 工具定义                       │      │
│  │  • 参数说明                       │      │
│  │  • 使用示例                       │      │
│  └────────────────────────────────────┘      │
│                  │                           │
│                  ▼                           │
│  ┌────────────────────────────────────┐      │
│  │  解析工具函数                     │      │
│  ├────────────────────────────────────┤      │
│  │  • 提取函数签名                   │      │
│  │  • 验证参数类型                   │      │
│  │  • 生成工具 Schema                │      │
│  └────────────────────────────────────┘      │
│                  │                           │
│                  ▼                           │
│  ┌────────────────────────────────────┐      │
│  │  技能安装检查                     │      │
│  ├────────────────────────────────────┤      │
│  │  ├─ 检查依赖                     │      │
│  │  ├─ 环境变量                     │      │
│  │  └─ 权限要求                     │      │
│  └────────────────────────────────────┘      │
│                  │                           │
│                  ▼                           │
│  ┌────────────────────────────────────┐      │
│  │  安装到 Agent 工作空间            │      │
│  ├────────────────────────────────────┤      │
│  │  • 复制文件                       │      │
│  │  • 注入环境变量                   │      │
│  │  • 注册到 Agent                   │      │
│  └────────────────────────────────────┘      │
│                  │                           │
│                  ▼                           │
│  ┌────────────────────────────────────┐      │
│  │  技能就绪                         │      │
│  │  • Agent 可调用                   │      │
│  │  • 自动提示用户                   │      │
│  └────────────────────────────────────┘      │
└──────────────────────────────────────────────┘
```

### 6.2 技能执行流程

```
┌─────────────────┐
│ Agent 请求技能  │
└────────┬────────┘
         │
         ▼
┌────────────────────────────────────────┐
│  技能类型识别                         │
└────┬───────────────────────────────────┘
     │
     ├──────────┬──────────┬──────────┐
     │          │          │          │
     ▼          ▼          ▼          ▼
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│密码管理│ │笔记操作│ │日历管理│ │消息发送│
│技能    │ │技能    │ │技能    │ │技能    │
└───┬────┘ └───┬────┘ └───┬────┘ └───┬────┘
    │          │          │          │
    ▼          ▼          ▼          ▼
┌──────────────────────────────────────────┐
│  技能执行                              │
├──────────────────────────────────────────┤
│  1Password:                           │
│  ├─ 连接 1Password CLI                 │
│  ├─ 查询密码条目                       │
│  └─ 返回凭证                          │
│                                         │
│  Apple Notes:                           │
│  ├─ 使用 AppleScript API                │
│  ├─ 创建/搜索/编辑笔记                 │
│  └─ 返回笔记内容                       │
│                                         │
│  Calendar:                              │
│  ├─ 访问系统日历                       │
│  ├─ 创建/查询/删除事件                 │
│  └─ 返回事件详情                       │
│                                         │
│  Communication:                         │
│  ├─ 调用消息通道 API                   │
│  ├─ 发送消息到指定平台                 │
│  └─ 返回发送状态                       │
└──────────────────────────────────────────┘
     │          │          │          │
     └──────────┴──────────┴──────────┘
                       │
                       ▼
              ┌────────────────┐
              │ 返回技能结果   │
              │ 到 Agent       │
              └────────────────┘
```

## 七、关键业务场景

### 7.1 场景1：新用户首次交互

```
┌──────────────────────────────────────────┐
│  场景：新用户首次发送消息              │
└──────────────────────────────────────────┘

步骤流程:
┌─────────┐
│ 开始    │
└────┬────┘
     │
     ▼
┌──────────────────┐
│ 用户在WhatsApp   │
│ 发送"Hello"     │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Gateway检查用户  │
│ (未知用户)       │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ 返回配对请求     │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ 用户确认配对     │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ 创建用户配置     │
│ 创建新会话       │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Agent发送欢迎消息│
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ 用户收到回复     │
└────┬─────────────┘
     │
     ▼
┌─────────┐
│ 结束   │
└────────┘
```

### 7.2 场景2：复杂任务处理

```
┌──────────────────────────────────────────┐
│  场景：查询天气并添加到日历            │
└──────────────────────────────────────────┘

用户消息: "查一下明天的天气并添加到日历"

           ┌─────────┐
           │  开始   │
           └────┬────┘
                │
                ▼
       ┌──────────────────┐
       │ Agent 分析意图    │
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 识别需要2个工具:  │
       │ 1. web_search   │
       │ 2. calendar_create│
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 执行 web_search │
       │ 查询明天天气    │
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 获取天气信息:   │
       │ "明天晴, 25°C"  │
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 执行 calendar_create│
       │ 创建日历事件     │
       │ - 标题: 天气提醒 │
       │ - 时间: 明天     │
       │ - 内容: 晴, 25°C│
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 返回确认消息:    │
       │ "已添加到日历， │
       │  明天晴25°C"   │
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │     结束        │
       └─────────────────┘
```

### 7.3 场景3：浏览器自动化

```
┌──────────────────────────────────────────┐
│  场景：打开亚马逊搜索耳机并截图        │
└──────────────────────────────────────────┘

用户消息: "打开亚马逊搜索耳机并截图"

           ┌─────────┐
           │  开始   │
           └────┬────┘
                │
                ▼
       ┌──────────────────┐
       │ Agent 调用工具:  │
       │ browser_navigate │
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 启动/连接浏览器  │
       │ (Chrome DevTools)│
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 执行: 导航到     │
       │ amazon.com       │
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 调用: browser_type│
       │ 输入搜索词       │
       │ "耳机"           │
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 调用: browser_screenshot│
       │ 截取搜索结果页面 │
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 返回截图给用户   │
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │ 询问: 需要进一步  │
       │ 操作吗？          │
       └────┬─────────────┘
            │
            ▼
       ┌──────────────────┐
       │     结束        │
       └─────────────────┘
```

### 7.4 场景4：多设备协作

```
┌──────────────────────────────────────────┐
│  场景：iPhone语音 → Mac浏览器 → iPhone │
└──────────────────────────────────────────┘

步骤流程:
┌─────────┐
│ iPhone  │
│ 语音输入│
└────┬────┘
     │
     ▼
┌──────────────────┐
│ 发送到Gateway    │
│ "搜索天气"      │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ 路由到Agent     │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ Agent决策:      │
│ 使用Mac浏览器    │
└────┬─────────────┘
     │
     ▼
┌──────────────────┐
│ 调用browser_tool│
│ 到Mac设备       │
└────┬─────────────┘
     │
     ▼
┌─────────┐
│ Mac    │
│打开Chrome│
└────┬────┘
     │
     ▼
┌──────────┐
│ 搜索天气 │
└────┬─────┘
     │
     ▼
┌──────────┐
│ 返回结果 │
└────┬─────┘
     │
     ▼
┌──────────────────┐
│ Gateway返回结果  │
│ 到iPhone显示     │
└────┬─────────────┘
     │
     ▼
┌─────────┐
│ iPhone  │
│ 显示结果│
└─────────┘
```

## 八、错误处理与恢复

### 8.1 错误处理流程

```
┌──────────────────────────────────────────┐
│          错误检测                      │
└────────┬───────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────┐
│          错误分类                      │
├──────────┬──────────┬──────────┬────────┤
│消息发送  │工具执行  │网络断开  │Agent   │
│失败      │失败      │          │超时    │
└────┬─────┘└────┬─────┘└────┬─────┘└───┬────┘
     │           │          │          │
     ▼           ▼          ▼          ▼
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│重试机制 │ │捕获错误 │ │自动重连 │ │保存部分│
│最多3次  │ │返回Agent│ │恢复状态 │ │结果    │
└────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
     │           │          │          │
     ▼           ▼          ▼          ▼
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│降级到   │ │尝试替代 │ │重放未发│ │提供重试│
│其他通道 │ │方案     │ │送消息   │ │选项    │
└────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘
     │           │          │          │
     └───────────┴──────────┴──────────┘
                     │
                     ▼
            ┌────────────────┐
            │ 记录错误日志   │
            └───────┬────────┘
                    │
                    ▼
            ┌────────────────┐
            │ 通知用户       │
            └────────────────┘
```

### 8.2 网络断开恢复

```
┌────────────────┐
│  检测到网络   │
│  断开         │
└───────┬────────┘
        │
        ▼
┌────────────────────────────────────┐
│  立即操作                         │
│  ├─ 标记连接状态为离线            │
│  ├─ 保存未发送消息队列            │
│  └─ 记录断开时间戳               │
└───────┬────────────────────────────┘
        │
        ▼
┌────────────────────────────────────┐
│  重连策略                         │
│  ├─ 指数退避算法 (1s, 2s, 4s...) │
│  ├─ 最多重试 N 次                 │
│  └─ 超过阈值后通知用户            │
└───────┬────────────────────────────┘
        │
        ▼
┌────────────────────────────────────┐
│  连接恢复                         │
│  ├─ 重新认证                      │
│  ├─ 恢复会话状态                 │
│  ├─ 重放消息队列                  │
│  └─ 同步错过的事件                │
└───────┬────────────────────────────┘
        │
        ▼
┌────────────────┐
│  恢复正常     │
└────────────────┘
```
