# Moltbot 系统架构图

## 一、整体分层架构

### 1.1 系统全景图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端层 (Clients)                            │
│  ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐                 │
│  │ CLI  │   │ Web  │   │macOS │   │ iOS  │   │Android│                │
│  └───┬──┘   └───┬──┘   └───┬──┘   └───┬──┘   └───┬──┘                 │
│      │          │          │          │          │                       │
└──────┼──────────┼──────────┼──────────┼──────────┼───────────────────────┘
       │          │          │          │          │
       └──────────┴──────────┴──────────┴──────────┘
                              │
                    ┌─────────▼─────────┐
                    │  WebSocket 连接    │
                    │   (Port: 18789)   │
                    └─────────┬─────────┘
                              │
┌─────────────────────────────▼──────────────────────────────────────────────┐
│                           网关层 (Gateway Core)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │
│  │   认证授权   │  │   会话管理   │  │   事件总线   │                     │
│  │    Auth     │  │   Sessions   │  │  Event Bus  │                     │
│  └─────────────┘  └─────────────┘  └─────────────┘                     │
│                                                                             │
│  ┌────────────────────────────────────────────────────────┐                 │
│  │              WebSocket 服务器                          │                 │
│  │         (TypeBox Schema + JSON Validation)            │                 │
│  └────────────────────────────────────────────────────────┘                 │
└────────────┬──────────────────────────────────────────┬────────────────────┘
             │                                          │
    ┌────────▼────────┐                        ┌───────▼───────┐
    │                 │                        │               │
┌───▼────────┐  ┌────▼─────┐          ┌─────▼─────┐  ┌──▼───────────┐
│  通道层     │  │          │          │  智能体层   │  │              │
│ Channels   │  │          │          │   Agents   │  │              │
├───────────┤  │          │          ├────────────┤  │              │
│▶ WhatsApp  │  │          │          │ ┌────────┐ │  │              │
│▶ Telegram  │  │          │          │ │Pi Agent│ │  │              │
│▶ Slack     │  │          │          │ │Runtime │ │  │              │
│▶ Discord   │  │          │          │└────────┘ │  │              │
│▶ Signal    │  │          │          │ ┌────────┐ │  │              │
│▶ iMessage  │  │          │          │ │ Tools  │ │  │              │
│▶ WebChat   │  │          │          │ │Exec    │ │  │              │
│▶ 其他...   │  │          │          │└────────┘ │  │              │
└────────────┘  │          │          │ ┌────────┐ │  │              │
                │          │          │ │ Memory │ │  │              │
┌───────────────▼──┐  ┌───▼─────────▼─▼───┐      │  │              │
│   扩展层         │  │   工具层          │      │  │              │
│  Extensions     │  │    Tools         │      │  │              │
├────────────────┤  ├─────────────────┤      │  │              │
│ ▶ 插件系统      │  │ ▶ 浏览器控制     │      │  │              │
│ ▶ 技能库        │  │ ▶ 画布渲染       │◄─────┘  │              │
│ ▶ 30+ 通道插件  │  │ ▶ 设备节点       │         │              │
└────────────────┘  │ ▶ 技能框架       │◄────────┘              │
                   └─────────────────┘                          │
                                                              │
┌─────────────────────────────────────────────────────────────┘ │
│                     数据存储层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │
│  │配置文件   │  │会话存储   │  │Agent数据  │                 │
│  │ Config   │  │ Sessions │  │AgentData │                 │
│  └──────────┘  └──────────┘  └──────────┘                 │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 各层职责说明

```
┌─────────────────────────────────────────────────────────────────┐
│ 层级名称          │ 职责描述                                 │
├─────────────────────────────────────────────────────────────────┤
│ 客户端层          │ 用户交互界面，连接Gateway控制              │
│ (Clients)        │ - CLI命令行                               │
│                  │ - Web管理界面                              │
│                  │ - 原生应用(macOS/iOS/Android)             │
├─────────────────────────────────────────────────────────────────┤
│ 网关层            │ 核心控制平面，管理所有连接和路由           │
│ (Gateway)        │ - WebSocket服务器(18789端口)               │
│                  │ - 认证和授权                              │
│                  │ - 会话管理                                 │
│                  │ - 事件广播                                 │
├─────────────────────────────────────────────────────────────────┤
│ 通道层            │ 消息平台集成，统一消息接口                 │
│ (Channels)       │ - WhatsApp/Telegram/Slack/Discord等       │
│                  │ - 消息收发                                 │
│                  │ - 群组处理                                 │
├─────────────────────────────────────────────────────────────────┤
│ 智能体层          │ AI推理和执行引擎                          │
│ (Agents)         │ - Pi Agent运行时                          │
│                  │ - 工具调用                                 │
│                  │ - 上下文管理                               │
│                  │ - 向量记忆                                 │
├─────────────────────────────────────────────────────────────────┤
│ 工具层            │ 具体能力实现                               │
│ (Tools)          │ - 浏览器自动化                            │
│                  │ - 画布渲染                                 │
│                  │ - 设备节点操作                             │
│                  │ - 技能框架                                 │
├─────────────────────────────────────────────────────────────────┤
│ 扩展层            │ 可插拔的功能扩展                          │
│ (Extensions)     │ - 插件系统                                 │
│                  │ - 技能库                                   │
│                  │ - 第三方通道                                │
├─────────────────────────────────────────────────────────────────┤
│ 数据存储层        │ 持久化存储                                 │
│ (Storage)        │ - 配置文件                                 │
│                  │ - 会话历史                                 │
│                  │ - Agent数据                                │
└─────────────────────────────────────────────────────────────────┘
```

## 二、核心组件详细架构

### 2.1 Gateway 网关核心

```
┌─────────────────────────────────────────────────────────────────┐
│                      Gateway 网关核心                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────┐           │
│  │              协议层 (Protocol Layer)            │           │
│  ├──────────────────────────────────────────────────┤           │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐   │           │
│  │  │Gateway   │  │WebSocket │  │  REST    │   │           │
│  │  │ Protocol │  │  Server  │  │   API    │   │           │
│  │  │(TypeBox) │  │(ws://...) │  │(/api/*)  │   │           │
│  │  └──────────┘  └──────────┘  └──────────┘   │           │
│  └──────────────────────────────────────────────────┘           │
│                          │                                     │
│                          ▼                                     │
│  ┌──────────────────────────────────────────────────┐           │
│  │              管理层 (Management Layer)          │           │
│  ├──────────────────────────────────────────────────┤           │
│  │  ┌──────────────┐  ┌──────────────┐           │           │
│  │  │   Channel    │  │    Session   │           │           │
│  │  │   Manager    │  │   Manager    │           │           │
│  │  │  通道管理器   │  │  会话管理器   │           │           │
│  │  └──────────────┘  └──────────────┘           │           │
│  │  ┌──────────────┐  ┌──────────────┐           │           │
│  │  │   Client     │  │   Security   │           │           │
│  │  │   Manager    │  │   Manager    │           │           │
│  │  │ 客户端管理器  │  │  安全管理器   │           │           │
│  │  └──────────────┘  └──────────────┘           │           │
│  └──────────────────────────────────────────────────┘           │
│                          │                                     │
│                          ▼                                     │
│  ┌──────────────────────────────────────────────────┐           │
│  │              处理层 (Processing Layer)           │           │
│  ├──────────────────────────────────────────────────┤           │
│  │  ┌──────────────┐  ┌──────────────┐           │           │
│  │  │   Message    │  │    Event     │           │           │
│  │  │   Router     │  │   Handler    │           │           │
│  │  │  消息路由器   │  │  事件处理器   │           │           │
│  │  └──────────────┘  └──────────────┘           │           │
│  │  ┌──────────────┐                         │           │
│  │  │    Stream    │                         │           │
│  │  │   Processor  │                         │           │
│  │  │  流处理器     │                         │           │
│  │  └──────────────┘                         │           │
│  └──────────────────────────────────────────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 Channels 通道系统

```
┌─────────────────────────────────────────────────────────────────┐
│                    Channels 通道系统                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────┐              │
│  │       Channel Interface (基础通道接口)        │              │
│  │  ├─ sendMessage()  发送消息                  │              │
│  │  ├─ onMessage()    接收消息                  │              │
│  │  ├─ capabilities   通道能力                  │              │
│  │  └─ metadata      通道元数据                 │              │
│  └──────────────────────────────────────────────┘              │
│                          │                                     │
│         ┌────────────────┼────────────────┐                   │
│         │                │                │                    │
│    ┌────▼────┐     ┌────▼────┐     ┌────▼────┐              │
│    │WhatsApp │     │Telegram │     │ Slack   │              │
│   ┌─┴───────┐   ┌─┴───────┐   ┌─┴───────┐              │
│   │Baileys  │   │ grammY  │   │  Bolt   │              │
│   └─────────┘   └─────────┘   └─────────┘              │
│                                                  │          │
│    ┌────▼────┐     ┌────▼────┐     ┌────▼────┐   │          │
│    │Discord  │     │ Signal  │     │iMessage │   │          │
│   ┌─┴───────┐   ┌─┴───────┐   ┌─┴───────┐   │          │
│   │Discord  │   │Signal   │   │AppleScript│   │          │
│   │API      │   │Client   │   │   APIs  │   │          │
│   └─────────┘   └─────────┘   └─────────┘   │          │
│                                     │          │          │
│    ┌────▼────┐     ┌────▼────┐     │          │          │
│    │WebChat  │     │ Matrix  │     │          │          │
│   ┌─┴───────┐   ┌─┴───────┐     │          │          │
│   │ HTTP    │   │Matrix   │     │          │          │
│   │ API     │   │SDK      │     │          │          │
│   └─────────┘   └─────────┘     │          │          │
│                                   │          │          │
│    ┌────────┴────────┴─────────┘ │          │          │
│    │        其他扩展通道...        │          │          │
│    │  - Zalo                    │          │          │
│    │  - LINE                     │          │          │
│    │  - Microsoft Teams          │          │          │
│    └─────────────────────────────┘          │          │
│                                              │          │
└──────────────────────────────────────────────────────────────┘
```

### 2.3 Agents 智能体层

```
┌─────────────────────────────────────────────────────────────────┐
│                   Agents 智能体层                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────┐           │
│  │           Pi Agent Core (智能体核心)            │           │
│  ├──────────────────────────────────────────────────┤           │
│  │  ┌────────────────────────────────────────┐    │           │
│  │  │     Agent Runtime (智能体运行时)       │    │           │
│  │  │  - 消息处理                           │    │           │
│  │  │  - 工具调用                           │    │           │
│  │  │  - 流式响应                           │    │           │
│  │  └────────────────────────────────────────┘    │           │
│  │           │                                  │           │
│  │           ├────────────────┐                  │           │
│  │           │                │                  │           │
│  │  ┌────────▼──────┐  ┌────▼─────┐          │           │
│  │  │ Tool Streaming │  │ Context  │          │           │
│  │  │ 工具流式执行   │  │ Manager  │          │           │
│  │  │              │  │ 上下文   │          │           │
│  │  │ - 浏览器      │  │ 管理     │          │           │
│  │  │ - 画布        │  │          │          │           │
│  │  │ - 节点        │  │ - 历史   │          │           │
│  │  │ - 会话        │  │ - 压缩   │          │           │
│  │  └──────────────┘  └──────────┘          │           │
│  └──────────────────────────────────────────────┘           │
│                          │                                     │
│                          ▼                                     │
│  ┌──────────────────────────────────────────────────┐           │
│  │            记忆系统 (Memory System)            │           │
│  ├──────────────────────────────────────────────────┤           │
│  │  ┌──────────────┐  ┌──────────────┐           │           │
│  │  │  Vector      │  │   LanceDB    │           │           │
│  │  │   Memory     │  │   Storage    │           │           │
│  │  │  向量记忆     │  │  向量数据库   │           │           │
│  │  └──────────────┘  └──────────────┘           │           │
│  │  ┌──────────────┐                         │           │
│  │  │   Memory     │                         │           │
│  │  │   Search    │                         │           │
│  │  │  记忆搜索    │                         │           │
│  │  └──────────────┘                         │           │
│  └──────────────────────────────────────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 Tools 工具系统

```
┌─────────────────────────────────────────────────────────────────┐
│                    Tools 工具系统                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────┐              │
│  │         工具执行器 (Tool Executor)          │              │
│  │  - 权限验证                                 │              │
│  │  - 参数解析                                 │              │
│  │  - 执行调度                                 │              │
│  │  - 结果流式返回                             │              │
│  └──────────────────────────────────────────────┘              │
│                          │                                     │
│         ┌────────────────┼────────────────┐                   │
│         │                │                │                    │
│    ┌────▼────┐     ┌────▼────┐     ┌────▼────┐              │
│    │ Browser  │     │ Canvas  │     │  Nodes  │              │
│    │  Tool   │     │  Tool   │     │  Tool   │              │
│   ┌─┴───────┐   ┌─┴───────┐   ┌─┴───────┐              │
│   │Playwright│   │A2UI协议  │   │设备节点  │              │
│   │控制浏览器│   │画布渲染  │   │mac/iOS/  │              │
│   │- 导航    │   │HTML/CSS  │   │Android   │              │
│   │- 截图    │   │实时更新  │   │相机/麦克风│             │
│   │- 输入    │   │          │   │传感器    │              │
│   └─────────┘   └─────────┘   └─────────┘              │
│                                       │                     │
│                            ┌──────────┘                    │
│                            │                              │
│                     ┌──────▼──────┐                       │
│                     │  Sessions   │                       │
│                     │    Tool    │                       │
│                     │  会话工具   │                       │
│                     │ - 创建     │                       │
│                     │ - 查询     │                       │
│                     │ - 删除     │                       │
│                     └────────────┘                       │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## 三、目录结构说明

### 3.1 核心目录

```
moltbot/
├── src/                          # 核心应用源代码 (1,615个TS文件)
│   ├── cli/                      # 命令行接口
│   │   ├── commands/             # CLI命令实现
│   │   └── utils/               # CLI工具函数
│   ├── gateway/                  # WebSocket网关服务器
│   │   ├── protocol/            # 协议定义
│   │   ├── server.ts            # 服务器入口
│   │   └── client/             # 客户端连接管理
│   ├── agents/                   # AI智能体运行时
│   │   ├── pi/                 # Pi Agent集成
│   │   ├── tools/              # 工具执行
│   │   └── memory/             # 记忆管理
│   ├── channels/                 # 消息通道实现
│   │   ├── base/               # 基础通道接口
│   │   ├── whatsapp/           # WhatsApp集成
│   │   ├── telegram/           # Telegram集成
│   │   └── slack/              # Slack集成
│   ├── config/                   # 配置系统
│   │   ├── schema.ts           # Zod schema定义
│   │   └── defaults.ts         # 默认配置
│   ├── plugins/                  # 插件系统
│   │   ├── loader/             # 插件加载器
│   │   └── hooks/              # 钩子管理
│   ├── tools/                    # 工具实现
│   │   ├── browser/            # 浏览器控制
│   │   ├── canvas/             # 画布渲染
│   │   └── nodes/              # 节点工具
│   ├── skills/                   # 技能框架
│   ├── sessions/                 # 会话管理
│   ├── security/                 # 安全处理
│   └── ...其他核心模块
│
├── extensions/                   # 通道/功能扩展 (30+插件)
│   ├── discord/                 # Discord通道
│   ├── slack/                   # Slack通道
│   ├── telegram/                # Telegram通道
│   ├── matrix/                  # Matrix通道
│   ├── msteams/                 # Teams通道
│   ├── zalo/                    # Zalo通道
│   └── memory-core/             # 记忆扩展
│
├── ui/                          # Web控制界面
│   ├── src/
│   │   └── components/          # Lit组件
│   ├── public/                  # 静态资源
│   └── vite.config.ts           # Vite配置
│
├── apps/                        # 原生应用
│   ├── macos/                   # macOS应用
│   │   └── Clawd/
│   ├── ios/                     # iOS应用
│   │   └── Moltbot/
│   └── android/                 # Android应用
│       └── app/
│
├── skills/                      # 智能体技能库
│   ├── 1password/               # 1Password集成
│   ├── apple-notes/             # Apple Notes
│   ├── calendar/                # 日历管理
│   └── ...其他技能
│
└── docs/                        # 官方文档站点
    ├── concepts/                # 概念文档
    ├── channels/                # 通道文档
    └── cli/                     # CLI参考
```

## 四、关键组件说明

### 4.1 Gateway 网关核心
- **WebSocket服务器**: 监听18789端口，处理所有客户端连接
- **协议实现**: 基于TypeBox的JSON Schema验证
- **会话管理**: 管理所有AI会话和状态
- **事件总线**: 广播事件到所有连接的客户端

### 4.2 Channels 通道系统
- **统一接口**: 所有通道实现相同的基础接口
- **路由管理**: 智能消息路由和允许列表管理
- **群组处理**: 支持@提及和群组消息过滤

### 4.3 Agents 智能体
- **Pi Agent核心**: 嵌入式智能体运行时
- **工具执行**: 50+内置工具支持
- **上下文管理**: 消息历史和记忆检索
- **模型支持**: 多提供商支持和故障转移

### 4.4 Plugins 插件系统
- **自动发现**: 扫描并加载扩展目录
- **清单验证**: 验证clawdbot.plugin.json
- **钩子系统**: 生命周期和事件钩子
- **依赖管理**: 自动处理插件依赖

### 4.5 Skills 技能框架
- **三种类型**: 捆绑、托管、工作区技能
- **工具定义**: SKILL.md描述和工具函数
- **环境注入**: 安全的环境变量注入
- **自动提示**: 智能技能发现和推荐

## 五、数据流向

### 5.1 客户端 → Gateway → Agent

```
客户端                Gateway                  Agent
  │                     │                      │
  ├── WebSocket连接 ───▶│                      │
  │                     │                      │
  ├── 发送命令 ────────▶│                      │
  │  (agent/send)       │                      │
  │                     ├── 验证权限 ────────▶│
  │                     │                      ├── 处理请求
  │                     │◀──── 流式响应 ──────┤
  │◀── 广播事件 ────────┤                      │
  │                     │                      │
```

**流程说明**：
1. 客户端通过WebSocket连接到Gateway
2. 发送命令（agent, send, channels.*等）
3. Gateway验证权限并路由到相应组件
4. Agent处理请求并流式返回结果
5. Gateway广播事件到所有订阅的客户端

### 5.2 通道 → Gateway → Agent → 通道

```
用户        通道              Gateway         Agent
 │            │                  │             │
 ├── 发送消息 ▶│                  │             │
 │            ├── 转发消息 ─────▶│             │
 │            │                  ├── 路由 ────▶│
 │            │                  │             ├── AI处理
 │            │                  │◀── 响应 ───┤
 │◀── 接收回复 ┤                  │             │
 │            │                  │             │
```

**流程说明**：
1. 用户在消息平台发送消息
2. 通道接收并转发到Gateway
3. Gateway路由到相应的Agent会话
4. Agent处理（可能调用工具）
5. 响应通过Gateway返回通道
6. 通道发送回复给用户

### 5.3 Agent → Tools → 结果

```
Agent              Gateway          Tool Executor        Tool
 │                   │                  │              │
 ├── 决定调用工具 ─▶│                  │              │
 │                   ├── 验证权限 ─────▶│              │
 │                   │                  ├── 执行 ────▶│
 │                   │                  │              ├── 运行
 │◀── 流式结果 ──────┤◀─────────────────┤              │
 │                   │                  │              │
```

**流程说明**：
1. Agent决定需要调用工具
2. Gateway验证工具权限
3. 工具执行器运行工具（本地或远程节点）
4. 结果流式返回给Agent
5. Agent继续处理（可能需要多次工具调用）
